#!/bin/bash
# Executed by init script

# load/set general global vars
INITHOOKS_DEFAULT="${INITHOOKS_DEFAULT:-/etc/default/inithooks}"
# shellcheck source=/dev/null
source "$INITHOOKS_DEFAULT"
TERM=${TERM:-linux}
RUN_FIRSTBOOT="${RUN_FIRSTBOOT:-}"
RUN_FIRSTBOOT="${RUN_FIRSTBOOT,,}"
if [[ -f $INITHOOKS_CONF ]]; then
    # shellcheck source=/dev/null
    source "$INITHOOKS_CONF"
    export INITHOOKS_CONF=$INITHOOKS_CONF
fi
TKLINFO="${TKLINFO:-/var/lib/turnkey-info}"
export INITHOOKS_LOGFILE="${INITHOOKS_LOGFILE:-/var/log/inithooks.log}"
PID=

# initalise log file
mkdir -p "$(dirname "$INITHOOKS_LOGFILE")"
touch "$INITHOOKS_LOGFILE"
chmod 640 "$INITHOOKS_LOGFILE"

log() {
    # log to journal as well as $INITHOOKS_LOGFILE
    local level=${1} # err|warn|info|debug
    shift
    logger -t inithooks -p "${level,,}" "$@"
    if [[ -f "$INITHOOKS_LOGFILE" ]]; then
        echo "${level^^}: $*" >> "$INITHOOKS_LOGFILE"
    fi
}

if [[ "${REDIRECT_OUTPUT,,}" == "true" ]]; then
    # on xen redirection is performed by the inithooks-xen service
    # on lxc and other headless deployments, redirection is handled below
    # otherwise redirection is handled by inithooks service and redirected to
    # tty8

    if [[ ! -f "$TKLINFO/xen" ]]; then
        TTY=$(cat /sys/devices/virtual/tty/tty0/active)
        if [[ -z $TTY ]]; then
            TTY=console
        fi
        tail -f "$INITHOOKS_LOGFILE" > "/dev/$TTY" &
        PID="$!"
    fi
fi

exec_scripts() {
    local script_dir=$1
    local script_executable=
    local script=
    [[ -d "$script_dir" ]] || return 0
    for script_executable in $(find "$script_dir" -type f -or -type l | sort); do
        script=$(basename "$script_executable")
        if [[ ! -x "$script_executable" ]]; then
            log warn "[$script] skipping"
            continue
        fi
        log info "[$script] running"
        "$script_executable"
        exit_code=$?
        if [[ "$exit_code" -eq 0 ]]; then
            log info "[$script] successfully completed"
        elif [[ "$script" = "95secupdates" ]] && [[ "$exit_code" -eq 2 ]]; then
            log info "[$script] detected live system - skipping"
        elif [[ "$script" = "95secupdates" ]] && [[ "$exit_code" -eq 42 ]]; then
            log warn "[$script] reboot is required"
            log err 'Rebooting now!'
            systemctl reboot
            exit 0
        else
            log err "[$script] failed - exit code $exit_code"
        fi
    done
    return 0
}


if [[ "$RUN_FIRSTBOOT" == "true" ]]; then
    log info "Running firstboot scripts"
    exec_scripts "$INITHOOKS_PATH/firstboot.d"
fi
log info "Running firstboot scripts"
exec_scripts "$INITHOOKS_PATH/everyboot.d"

if [[ -n "$PID" ]];  then
    kill -9 $PID || true
fi

if [[ "${REDIRECT_OUTPUT,,}" == "true" ]]; then
    log info "Inithook run completed, exiting."
else
    log info "Inithook run completed, now starting confconsole"
    sleep 2 # anyway to replace this?
    confconsole --usage
    log info "Confconsole started, inithooks exiting"
fi

exit 0
